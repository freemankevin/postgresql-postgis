name: Build and Push Docker Images

on:
  schedule:
    - cron: "00 16 * * *" # 每天 UTC 16:00 (CST 00:00)
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/build.yml'
      - 'pg_version.txt'
  workflow_dispatch:

jobs:
  update-versions:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.extract.outputs.versions }}
      changed: ${{ steps.extract.outputs.changed }}
      build_required: ${{ steps.check-images.outputs.build_required }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract PostgreSQL versions
        id: extract
        run: |
          declare -A versions
          CHANGED=false
          echo "Checking PostgreSQL versions..."
          for major in 12 13 14 15 16 17; do
            echo "Processing major version $major"
            docker build --build-arg PG_MAJOR=$major --no-cache -t temp-image .
            NEW_VERSION=$(docker run --rm temp-image cat /pg_version)
            versions[$major]=$NEW_VERSION
            OLD_VERSION=$(grep "^$major :" pg_version.txt | cut -d':' -f2 | tr -d ' ' || echo "")
            if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
              CHANGED=true
              echo "Version changed for $major: $OLD_VERSION -> $NEW_VERSION"
            fi
            sed -i "/^$major :/d" pg_version.txt || true
            echo "$major : $NEW_VERSION" >> pg_version.txt
          done
          sort -o pg_version.txt pg_version.txt
          
          # 构建 JSON 输出
          JSON="{ "
          for major in 12 13 14 15 16 17; do
            if [ "$major" != "12" ]; then
              JSON="$JSON, "
            fi
            JSON="$JSON\"$major\": \"${versions[$major]}\""
          done
          JSON="$JSON }"
          echo "versions=$JSON" >> $GITHUB_OUTPUT
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Check existing images
        id: check-images
        run: |
          BUILD_REQUIRED=false
          VERSIONS=$(echo '${{ steps.extract.outputs.versions }}' | jq -r 'to_entries | .[] | "\(.key) \(.value)"')
          while read -r major version; do
            IMAGE_TAG="ghcr.io/freemankevin/postgresql-postgis:${major}-${version}-bookworm-postgis3"
            if ! docker manifest inspect "$IMAGE_TAG" > /dev/null 2>&1; then
              echo "Image $IMAGE_TAG not found, build required"
              BUILD_REQUIRED=true
              break
            fi
          done <<< "$VERSIONS"
          echo "build_required=$BUILD_REQUIRED" >> $GITHUB_OUTPUT

      - name: Commit pg_version.txt
        if: steps.extract.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add pg_version.txt
          git commit -m "Update pg_version.txt with latest PostgreSQL versions"
          git push

  build:
    needs: update-versions
    if: |
      needs.update-versions.outputs.changed == 'true' ||
      needs.update-versions.outputs.build_required == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pg_major: [12, 13, 14, 15, 16, 17]
      fail-fast: false
      max-parallel: 3
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate Docker Hub tags
        id: dockerhub_meta
        uses: docker/metadata-action@v5
        with:
          images: freelabspace/postgresql-postgis
          tags: |
            type=raw,value=${{ steps.version.outputs.full_version }}

      - name: Build and push to GitHub Container Registry
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/freemankevin/postgresql-postgis:${{ steps.version.outputs.full_version }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: freelabspace/postgresql-postgis:${{ steps.version.outputs.full_version }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            PG_MAJOR=${{ matrix.pg_major }}
          push: true
          tags: ${{ steps.dockerhub_meta.outputs.tags }}
          labels: ${{ steps.dockerhub_meta.outputs.labels }}
          cache-from: |
            type=registry,ref=freelabspace/postgresql-postgis:buildcache-${{ matrix.pg_major }}
          cache-to: |
            type=registry,ref=freelabspace/postgresql-postgis:buildcache-${{ matrix.pg_major }},mode=max

      - name: Get PostgreSQL version
        id: version
        run: |
          PG_VERSION=$(echo '${{ needs.update-versions.outputs.versions }}' | jq -r ".\"${{ matrix.pg_major }}\"")
          echo "full_version=$PG_VERSION" >> $GITHUB_OUTPUT
          echo "postgis_version=3" >> $GITHUB_OUTPUT

      - name: Generate tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/freemankevin/postgresql-postgis
          tags: |
            type=raw,value=${{ steps.version.outputs.full_version }}

      - name: Build and push
        uses: docker/build-push-action@v6
        continue-on-error: true
        id: build_push
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          build-args: |
            PG_MAJOR=${{ matrix.pg_major }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=registry,ref=ghcr.io/freemankevin/postgresql-postgis:buildcache-${{ matrix.pg_major }}
          cache-to: |
            type=registry,ref=ghcr.io/freemankevin/postgresql-postgis:buildcache-${{ matrix.pg_major }},mode=max

      - name: Retry build and push on failure
        if: steps.build_push.outcome == 'failure'
        uses: docker/build-push-action@v6
        continue-on-error: true
        id: retry1
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          build-args: |
            PG_MAJOR=${{ matrix.pg_major }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=registry,ref=ghcr.io/freemankevin/postgresql-postgis:buildcache-${{ matrix.pg_major }}
          cache-to: |
            type=registry,ref=ghcr.io/freemankevin/postgresql-postgis:buildcache-${{ matrix.pg_major }},mode=max

      - name: Final retry build and push
        if: steps.build_push.outcome == 'failure' && steps.retry1.outcome == 'failure'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64,linux/arm64
          build-args: |
            PG_MAJOR=${{ matrix.pg_major }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=registry,ref=ghcr.io/freemankevin/postgresql-postgis:buildcache-${{ matrix.pg_major }}
          cache-to: |
            type=registry,ref=ghcr.io/freemankevin/postgresql-postgis:buildcache-${{ matrix.pg_major }},mode=max