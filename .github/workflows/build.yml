name: Build PostgreSQL with PostGIS

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'search-version.py'
      - '.github/workflows/build.yml'
  workflow_dispatch:

jobs:
  update-versions:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.extract.outputs.versions }}
      changed: ${{ steps.extract.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Extract PostgreSQL versions
        id: extract
        run: |
          echo "ðŸ” å¼€å§‹æ£€æŸ¥ PostgreSQL ç‰ˆæœ¬æ›´æ–°..."
          
          # è¿è¡Œç‰ˆæœ¬æ£€æŸ¥è„šæœ¬
          python search-version.py
          
          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          if [ ! -f pg_version.json ]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬æ£€æŸ¥è„šæœ¬æœªç”Ÿæˆ pg_version.json æ–‡ä»¶"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ£€æµ‹åˆ°çš„ç‰ˆæœ¬
          echo "ðŸ“¦ æ£€æµ‹åˆ°çš„ç‰ˆæœ¬:"
          cat pg_version.json | jq '.'
          
          echo "âœ… ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ"

      - name: Debug outputs
        run: |
          echo "ðŸ” è°ƒè¯•è¾“å‡ºå˜é‡:"
          echo "  versions: ${{ steps.extract.outputs.versions }}"
          echo "  changed: ${{ steps.extract.outputs.changed }}"
          echo "  changed type: $(echo '${{ steps.extract.outputs.changed }}' | cat -A)"

      - name: Commit pg_version.json
        if: steps.extract.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if ! git diff --quiet pg_version.json; then
            git add pg_version.json
            
            # ç”Ÿæˆæ›´è¯¦ç»†çš„ commit message
            echo "ðŸ“ ç”Ÿæˆ commit message"
            COMMIT_MSG="chore: Update PostgreSQL versions ($(date '+%Y-%m-%d'))"
            echo "" >> commit_msg.txt
            echo "Updated versions:" >> commit_msg.txt
            cat pg_version.json | jq -r 'to_entries[] | "- PostgreSQL \(.key): \(.value)"' >> commit_msg.txt
            
            git commit -F commit_msg.txt
            git push
            
            echo "âœ… ç‰ˆæœ¬æ–‡ä»¶å·²æäº¤"
          else
            echo "â„¹ï¸ pg_version.json æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

  # è°ƒè¯• job - å¸®åŠ©æŽ’æŸ¥ä¸ºä»€ä¹ˆ build è¢«è·³è¿‡
  debug-outputs:
    needs: update-versions
    runs-on: ubuntu-latest
    if: always()  # æ€»æ˜¯è¿è¡Œï¼Œç”¨äºŽè°ƒè¯•
    steps:
      - name: Display all outputs
        run: |
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "versions output: ${{ needs.update-versions.outputs.versions }}"
          echo "changed output: ${{ needs.update-versions.outputs.changed }}"
          echo "changed == 'true': ${{ needs.update-versions.outputs.changed == 'true' }}"
          echo "github.event_name: ${{ github.event_name }}"
          echo "Should build run?: ${{ needs.update-versions.outputs.changed == 'true' || github.event_name == 'workflow_dispatch' }}"

  build:
    needs: update-versions
    runs-on: ubuntu-latest
    # é‡è¦ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒï¼Œç¡®ä¿ outputs.changed æ˜¯å­—ç¬¦ä¸² 'true'
    if: |
      needs.update-versions.outputs.changed == 'true' || 
      github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        pg_major: [13, 14, 15, 16, 17, 18]
      fail-fast: false
      max-parallel: 2
    steps:
      - uses: actions/checkout@v4
        with:
          # å¦‚æžœæ˜¯å› ä¸ºç‰ˆæœ¬æ›´æ–°è§¦å‘çš„ï¼Œéœ€è¦æ‹‰å–æœ€æ–°çš„ pg_version.json
          ref: ${{ github.event_name == 'schedule' && 'main' || github.ref }}
          
      - uses: docker/setup-qemu-action@v3
      
      - uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Get PostgreSQL version
        id: version
        run: |
          echo "ðŸ“– è¯»å– PostgreSQL ${{ matrix.pg_major }} ç‰ˆæœ¬ä¿¡æ¯"
          
          # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
          if [ ! -f pg_version.json ]; then
            echo "âŒ é”™è¯¯: pg_version.json æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è¯»å–ç‰ˆæœ¬å·
          PG_VERSION=$(jq -r ".[\"${{ matrix.pg_major }}\"]" pg_version.json)
          
          # éªŒè¯ç‰ˆæœ¬å·
          if [ -z "$PG_VERSION" ] || [ "$PG_VERSION" = "null" ]; then
            echo "âŒ é”™è¯¯: PostgreSQL ${{ matrix.pg_major }} ç‰ˆæœ¬ä¸ºç©º"
            exit 1
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ (åº”è¯¥æ˜¯ X.Y æ ¼å¼)
          if ! [[ "$PG_VERSION" =~ ^[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®: $PG_VERSION"
            exit 1
          fi
          
          echo "full_version=$PG_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… å°†æž„å»º PostgreSQL $PG_VERSION"
          
      - name: Check if image exists
        id: check-image
        run: |
          IMAGE_TAG="${{ steps.version.outputs.full_version }}"
          echo "ðŸ” æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨: freelabspace/postgresql-postgis:$IMAGE_TAG"
          
          # ä½¿ç”¨Docker Hub APIæ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          STATUS=$(curl -s -w "%{http_code}" -o /dev/null \
            "https://hub.docker.com/v2/repositories/freelabspace/postgresql-postgis/tags/$IMAGE_TAG/")
          
          if [ "$STATUS" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ é•œåƒå·²å­˜åœ¨: $IMAGE_TAG"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ é•œåƒä¸å­˜åœ¨ï¼Œéœ€è¦æž„å»º: $IMAGE_TAG"
          fi

      - name: Build and push Docker image
        # å¦‚æžœé•œåƒä¸å­˜åœ¨æˆ–è€…æ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œå°±æž„å»º
        if: steps.check-image.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          # åªä½¿ç”¨å®Œæ•´ç‰ˆæœ¬å·ä½œä¸ºæ ‡ç­¾ï¼Œä¸ä½¿ç”¨ä¸»ç‰ˆæœ¬å·
          tags: freelabspace/postgresql-postgis:${{ steps.version.outputs.full_version }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            PG_MAJOR=${{ matrix.pg_major }}
            PG_VERSION=${{ steps.version.outputs.full_version }}
          # ä¸ä½¿ç”¨ build cacheï¼Œæ¯æ¬¡éƒ½æ˜¯å¹²å‡€æž„å»º
          
      - name: Image build summary
        if: steps.check-image.outputs.exists != 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "### ðŸ˜ PostgreSQL ${{ matrix.pg_major }} æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.full_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ**: \`freelabspace/postgresql-postgis:${{ steps.version.outputs.full_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          
      - name: Image skipped summary  
        if: steps.check-image.outputs.exists == 'true' && github.event_name != 'workflow_dispatch'
        run: |
          echo "### â­ï¸ PostgreSQL ${{ matrix.pg_major }} è·³è¿‡æž„å»º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "é•œåƒ \`freelabspace/postgresql-postgis:${{ steps.version.outputs.full_version }}\` å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY